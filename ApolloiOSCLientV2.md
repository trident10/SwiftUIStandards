import Foundation
import Apollo

// MARK: - Protocols

/// Protocol defining the error type requirements for GraphQL operations
protocol ErrorType: Error {
    init(message: String)
    init(from error: Error)
}

/// Protocol defining the configuration for GraphQL queries
protocol GraphQLConfig {
    associatedtype Query: GraphQLQuery
    associatedtype Error: ErrorType
    
    var url: URL { get }
    var query: Query { get }
}

// MARK: - Repository Extension

extension Repository {
    /// Performs a GraphQL query using Apollo client
    /// - Parameter config: The GraphQL configuration containing URL, query, and error type
    /// - Returns: A Result containing either the query data or an error
    func performGraphQLQuery<Config: GraphQLConfig>(
        _ config: Config
    ) async -> Result<Config.Query.Data, Config.Error> {
        
        // Create Apollo client with the provided URL
        let store = ApolloStore(cache: InMemoryNormalizedCache())
        let provider = DefaultInterceptorProvider(store: store)
        let transport = RequestChainNetworkTransport(
            interceptorProvider: provider,
            endpointURL: config.url
        )
        let client = ApolloClient(networkTransport: transport, store: store)
        
        // Perform the query using Swift concurrency
        do {
            let result = try await withCheckedThrowingContinuation { continuation in
                client.fetch(query: config.query) { result in
                    continuation.resume(with: result)
                }
            }
            
            guard let data = result.data else {
                let error = Config.Error(message: "No data received from GraphQL query")
                return .failure(error)
            }
            
            return .success(data)
            
        } catch {
            let customError = Config.Error(from: error)
            return .failure(customError)
        }
    }
}

// MARK: - Example Implementation

// Example concrete error type
struct NetworkError: ErrorType {
    let message: String
    let underlyingError: Error?
    
    init(message: String) {
        self.message = message
        self.underlyingError = nil
    }
    
    init(from error: Error) {
        if let apolloError = error as? Apollo.GraphQLError {
            self.message = apolloError.message ?? "GraphQL Error"
        } else {
            self.message = error.localizedDescription
        }
        self.underlyingError = error
    }
}

// Example GraphQL query (you would generate this using Apollo iOS code generation)
struct UserQuery: GraphQLQuery {
    let id: String
    
    var queryDocument: String {
        """
        query GetUser($id: ID!) {
            user(id: $id) {
                id
                name
                email
            }
        }
        """
    }
    
    var variables: [String: Any]? {
        ["id": id]
    }
    
    // This would be generated by Apollo
    struct Data: GraphQLSelectionSet {
        let user: User?
        
        struct User: GraphQLSelectionSet {
            let id: String
            let name: String
            let email: String
        }
    }
}

// Example concrete GraphQL configuration
struct UserGraphQLConfig: GraphQLConfig {
    typealias Query = UserQuery
    typealias Error = NetworkError
    
    let url: URL
    let query: UserQuery
    
    init(baseURL: URL, userId: String) {
        self.url = baseURL.appendingPathComponent("/graphql")
        self.query = UserQuery(id: userId)
    }
}

// MARK: - Usage Example

class ExampleUsage {
    let repository: Repository
    
    init(repository: Repository) {
        self.repository = repository
    }
    
    func fetchUser(userId: String) async {
        let config = UserGraphQLConfig(
            baseURL: URL(string: "https://api.example.com")!,
            userId: userId
        )
        
        let result = await repository.performGraphQLQuery(config)
        
        switch result {
        case .success(let data):
            if let user = data.user {
                print("User: \(user.name) - \(user.email)")
            } else {
                print("User not found")
            }
            
        case .failure(let error):
            print("Error fetching user: \(error.message)")
        }
    }
}

// MARK: - Alternative Implementation with Caching and Headers

extension Repository {
    /// Enhanced version with additional configuration options
    func performGraphQLQuery<Config: GraphQLConfig>(
        _ config: Config,
        headers: [String: String] = [:],
        cachePolicy: CachePolicy = .fetchIgnoringCacheData
    ) async -> Result<Config.Query.Data, Config.Error> {
        
        // Create Apollo client with custom configuration
        let cache = InMemoryNormalizedCache()
        let store = ApolloStore(cache: cache)
        
        let provider = DefaultInterceptorProvider(store: store)
        let transport = RequestChainNetworkTransport(
            interceptorProvider: provider,
            endpointURL: config.url,
            additionalHeaders: headers
        )
        
        let client = ApolloClient(networkTransport: transport, store: store)
        
        do {
            let result = try await withCheckedThrowingContinuation { continuation in
                client.fetch(
                    query: config.query,
                    cachePolicy: cachePolicy
                ) { result in
                    continuation.resume(with: result)
                }
            }
            
            guard let data = result.data else {
                let error = Config.Error(message: "No data received from GraphQL query")
                return .failure(error)
            }
            
            return .success(data)
            
        } catch {
            let customError = Config.Error(from: error)
            return .failure(customError)
        }
    }
}

// MARK: - Repository Protocol (for reference)

protocol Repository {
    // Your existing REST methods would be here
    // func performRESTRequest(...) async throws -> ...
}

// Concrete implementation
class NetworkRepository: Repository {
    // Your existing REST implementation
    // Now also includes GraphQL support through the extension
}
